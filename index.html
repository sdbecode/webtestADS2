<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RedGreen.boutik ‚Äî Boutique</title>
<meta name="description" content="RedGreen.boutik ‚Äî Boutique de mode f√©minine √† Abidjan.">
<style>
:root{
  --red:#d61f26;--green:#1ba579;--black:#111;--white:#fff;--gold:#c7a93a;
  --bg:#fafafa;--muted:#666;--card:#fff;--border:#eee;
}
*{box-sizing:border-box}html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Color Emoji","Apple Color Emoji",sans-serif;color:var(--black);background:var(--bg)}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
.container{max-width:1100px;margin:0 auto;padding:0 16px}
.header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(150%) blur(6px);border-bottom:1px solid var(--border)}
.header .row{display:flex;align-items:center;gap:16px;padding:10px 0}
.logo{font-weight:800;letter-spacing:.3px}
.logo i{font-style:normal;color:var(--green)}
.nav{margin-left:auto;display:flex;gap:10px;align-items:center}
.nav .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;font-size:.9rem;background:#fff}
.search{display:flex;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 10px}
.search input{border:0;outline:0;width:180px}
.icon-btn{position:relative;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px}
.badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border-radius:999px;padding:2px 6px;font-size:.7rem}
.hero{background:linear-gradient(135deg, #fff 0%, #f7faf8 60%);border-bottom:1px solid var(--border)}
.hero .wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:24px;padding:28px 0}
.hero h1{font-size:2rem;margin:.2rem 0}
.hero p{color:var(--muted);line-height:1.5}
.hero .banner{background:url('https://images.unsplash.com/photo-1520975693416-35a7d069f78f?q=80&w=1600&auto=format&fit=crop') center/cover;border-radius:18px;min-height:200px}
.actions{display:flex;gap:10px;margin-top:10px}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:600}
.btn.primary{background:var(--green);color:#fff}
.btn.ghost{background:#fff;border:1px solid var(--border)}
.section{padding:24px 0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
.card img{width:100%;height:210px;object-fit:cover;background:#f1f1f1}
.card .body{padding:12px;display:flex;flex-direction:column;gap:8px}
.price{font-weight:700;color:var(--black)}
.muted{color:var(--muted);font-size:.95rem}
.badge-sm{display:inline-block;background:#f6f6f6;border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:.75rem}
.kbd{font:600 .8rem ui-monospace,Menlo,monospace;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#fff}
.footer{padding:30px 0;border-top:1px solid var(--border);color:var(--muted);font-size:.95rem}
.footer a.icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;margin-right:8px;background:#fff}
.tags{display:flex;flex-wrap:wrap;gap:8px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
select, input[type="text"], input[type="number"], textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
label{font-weight:600;font-size:.92rem}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
.table tr:hover{background:#f9f9f9}
.table .switch{cursor:pointer}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:50}
.drawer{position:fixed;top:0;right:-420px;width:400px;max-width:100%;height:100%;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 20px rgba(0,0,0,.05);transition:.25s;z-index:40;display:flex;flex-direction:column}
.drawer.open{right:0}
.drawer header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.drawer .content{padding:10px 16px;overflow:auto;flex:1}
.drawer footer{border-top:1px solid var(--border);padding:12px 16px;display:grid;gap:10px}
.cart-line{display:grid;grid-template-columns:64px 1fr auto;gap:10px;margin:10px 0}
.cart-line img{width:64px;height:64px;border-radius:8px;object-fit:cover}
.qty{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.qty button{border:0;background:#fff;padding:6px 10px}
.qty input{width:40px;text-align:center;border:0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:45}
.modal.open{display:flex}
.modal .panel{background:#fff;max-width:920px;width:96%;border-radius:16px;overflow:hidden}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
.modal .body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
.gallery{display:grid;grid-template-columns:84px 1fr;gap:10px}
.gallery .thumbs{display:grid;gap:8px;max-height:360px;overflow:auto}
.gallery .thumbs img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
.gallery .thumbs img.active{border-color:var(--green)}
.gallery .main img,.gallery .main video{width:100%;height:360px;object-fit:cover;border-radius:12px;background:#f3f3f3}
.map{border:0;width:100%;height:260px;border-radius:16px}
.notice{padding:8px 12px;border:1px dashed var(--gold);background:#fff8d8;border-radius:10px;color:#7a6420}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.hero .wrap{grid-template-columns:1fr} .modal .body{grid-template-columns:1fr}}
@media(max-width:540px){.grid{grid-template-columns:1fr} .nav .chip{display:none} .search input{width:110px}}
</style>
</head>
<body>
<header class="header">
  <div class="container row">
    <div class="logo">RedGreen.<i>boutik</i></div>
    <div class="nav">
      <div class="search"><input id="q" type="text" placeholder="Rechercher‚Ä¶"><span class="kbd">/</span></div>
      <button id="btnCart" class="icon-btn" aria-label="Panier"><span>üõí</span><span id="cartBadge" class="badge" style="display:none">0</span></button>
      <a id="btnWhats" class="icon-btn" href="#" title="Nous √©crire sur WhatsApp">üí¨</a>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container wrap">
    <div>
      <h1>Mode f√©minine ‚Äî Abidjan, C√¥te d‚ÄôIvoire</h1>
      <p>Bienvenue chez <strong>RedGreen.boutik</strong> üëó ‚Äî nouveaut√©s, ensembles, robes & accessoires. Livraison rapide √† Abidjan. Paiement √† la livraison possible.</p>
      <div class="actions">
        <a href="#boutique" class="btn primary">Voir la boutique</a>
        <a id="btnAdmin" href="#admin" class="btn ghost">Espace Admin</a>
      </div>
      <div id="demoBanner" class="notice" style="display:none;margin-top:10px">Mode d√©mo actif : configurez <strong>SCRIPT_URL</strong> & <strong>API_TOKEN</strong> pour connecter Google Sheets.</div>
    </div>
    <div class="banner" aria-hidden="true"></div>
  </div>
</section>

<section id="boutique" class="section">
  <div class="container">
    <div class="toolbar">
      <span>Cat√©gories :</span>
      <div id="cats" class="tags"></div>
      <select id="sort">
        <option value="">Tri</option>
        <option value="price-asc">Prix ‚Üë</option>
        <option value="price-desc">Prix ‚Üì</option>
        <option value="new">Nouveaut√©s</option>
      </select>
    </div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>
</section>

<section id="contact" class="section">
  <div class="container">
    <h2>√Ä propos & contact</h2>
    <p>RedGreen.boutik ‚Äî Abidjan, C√¥te d‚ÄôIvoire. Suivez-nous :</p>
    <p>
      <a class="badge-sm" target="_blank" href="https://instagram.com/Red_Green.Boutik">Instagram</a>
      <a class="badge-sm" target="_blank" href="https://tiktok.com/@RedGreen.boutik">TikTok</a>
      <span class="badge-sm">Snapchat: RedGreenBoutik</span>
      <a class="badge-sm" target="_blank" href="#">Facebook (√† compl√©ter)</a>
    </p>
    <p><a id="btnWhats2" class="btn primary" href="#">Discuter sur WhatsApp</a></p>
    <iframe class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
      src="https://www.google.com/maps?q=Abidjan%2C%20C%C3%B4te%20d%E2%80%99Ivoire&output=embed"></iframe>
  </div>
</section>

<footer class="footer">
  <div class="container">
    <div>¬© <span id="year"></span> RedGreen.boutik ‚Äî Tous droits r√©serv√©s.</div>
    <div style="margin-top:8px">
      <a class="icon" target="_blank" href="https://instagram.com/Red_Green.Boutik">üì∑</a>
      <a class="icon" target="_blank" href="https://tiktok.com/@RedGreen.boutik">üéµ</a>
      <a class="icon" href="#admin" id="adminLink" title="Admin">üîê</a>
    </div>
  </div>
</footer>

<!-- Panier -->
<aside id="cart" class="drawer" aria-hidden="true">
  <header><strong>Panier</strong><button id="closeCart" class="btn ghost">Fermer</button></header>
  <div class="content">
    <div id="cartLines"></div>
    <hr>
    <div class="form-row">
      <div>
        <label>Nom complet</label>
        <input id="cName" type="text" placeholder="Votre nom" required>
      </div>
      <div>
        <label>T√©l√©phone</label>
        <input id="cPhone" type="text" placeholder="+225XXXXXXXXX" required>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Adresse de livraison</label>
      <textarea id="cAddr" rows="2" placeholder="Quartier, commune, rep√®re‚Ä¶" required></textarea>
    </div>
    <input id="hp" type="text" style="position:absolute;left:-9999px" aria-hidden="true" tabindex="-1">
    <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
      <div><strong>Total : <span id="cartTotal">0 FCFA</span></strong></div>
      <div class="muted">(TVA incluse)</div>
    </div>
  </div>
  <footer>
    <button id="checkout" class="btn primary">Terminer la commande sur WhatsApp</button>
    <button id="emptyCart" class="btn ghost">Vider le panier</button>
  </footer>
</aside>

<!-- Modale produit -->
<div id="productModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel">
    <header><strong id="mTitle">Produit</strong><button id="mClose" class="btn ghost">Fermer</button></header>
    <div class="body">
      <div class="gallery">
        <div class="thumbs" id="mThumbs"></div>
        <div class="main" id="mMain"></div>
      </div>
      <div>
        <div class="price" id="mPrice">‚Äî</div>
        <p id="mDesc" class="muted"></p>
        <div class="form-row">
          <div>
            <label>Taille</label>
            <select id="mSize"></select>
          </div>
          <div>
            <label>Couleur</label>
            <select id="mColor"></select>
          </div>
        </div>
        <div style="margin:10px 0">
          <label>Quantit√©</label>
          <div class="qty"><button id="mMinus">‚àí</button><input id="mQty" type="number" min="1" value="1"><button id="mPlus">+</button></div>
        </div>
        <div class="tags" id="mFlags"></div>
        <div class="actions"><button id="mAdd" class="btn primary">Ajouter au panier</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Admin (dans la m√™me page) -->
<section id="admin" class="section" style="display:none">
  <div class="container">
    <h2>Dashboard Admin</h2>
    <div class="toolbar">
      <button id="aRefresh" class="btn ghost">Rafra√Æchir depuis Sheets</button>
      <button id="aExport" class="btn ghost">Exporter JSON</button>
      <button id="aLogout" class="btn">Se d√©connecter</button>
      <span id="aStatus" class="muted"></span>
    </div>
    <div class="form-row">
      <div>
        <h3>Ajouter / Modifier</h3>
        <div class="form-row">
          <div><label>ID</label><input id="f_id" placeholder="(auto si vide)"></div>
          <div><label>Nom*</label><input id="f_nom" required></div>
        </div>
        <div class="form-row">
          <div><label>Prix (FCFA)*</label><input id="f_prix" type="number" required></div>
          <div><label>Cat√©gorie*</label><input id="f_cat" placeholder="Robes, Ensembles‚Ä¶"></div>
        </div>
        <div><label>Description*</label><textarea id="f_desc" rows="2" required></textarea></div>
        <div><label>Images (URLs s√©par√©es par ,)*</label><textarea id="f_imgs" rows="2" required placeholder="https://...jpg, https://...jpg"></textarea></div>
        <div class="form-row">
          <div><label>Vid√©o (URL)</label><input id="f_vid"></div>
          <div><label>Stock</label><input id="f_stock" type="number" value="10"></div>
        </div>
        <div class="form-row">
          <div><label>Tailles (CSV)</label><input id="f_sizes" placeholder="S,M,L,XL"></div>
          <div><label>Couleurs (CSV)</label><input id="f_colors" placeholder="Rouge,Bleu,Noir"></div>
        </div>
        <div style="margin:8px 0"><label><input id="f_pub" type="checkbox" checked> Publier</label></div>
        <div class="actions">
          <button id="aCreate" class="btn primary">Cr√©er</button>
          <button id="aUpdate" class="btn">Mettre √† jour</button>
          <button id="aDelete" class="btn ghost">Supprimer</button>
        </div>
      </div>
      <div>
        <h3>Produits</h3>
        <input id="aSearch" type="text" placeholder="Rechercher‚Ä¶">
        <div style="max-height:420px;overflow:auto;margin-top:8px">
          <table class="table" id="aTable">
            <thead><tr><th>ID</th><th>Nom</th><th>Prix</th><th>Cat</th><th>Pub</th><th>Stock</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* =========================
   CONFIG & CONSTANTS
========================= */
const CONFIG = {
  BUSINESS_NAME: "RedGreen.boutik",
  LOCATION: "Abidjan, C√¥te d‚ÄôIvoire",
  WHATSAPP_PHONE: "2250712623814",
  SCRIPT_URL: "https://script.google.com/macros/s/AKfycbzUpn2It-Mn9F4ILmnWEKbfYAvX_07Dy9nREnPChsFFQxAjb5JbLy-MRFudrq7XqeBF/exec", // <= ton URL /exec
  API_TOKEN: "rgb-2025-long-secret", // <= DOIT √™tre identique √† API_TOKEN_SHEET dans Code.gs
  ADMIN_USERNAME: "ADMIN",
  ADMIN_PASSWORD: "RedGreenB2025",
  CACHE_TTL_MS: 5 * 60 * 1000
};
const LS_KEYS={CART:"rg.cart", CACHE:"rg.cache.products", SESSION:"rg.session"};

/* =========================
   UTILS
========================= */
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));
const nowISO=()=>new Date().toISOString();
const nbsp = s => (s+"").replace(/\B(?=(\d{3})+(?!\d))/g," "); // espace ins√©cable
const formatXOF=v=>`${nbsp(Math.round(Number(v||0)))} FCFA`;
const parseCSV=s=> (s? s.split(",").map(x=>x.trim()).filter(Boolean):[]);
const joinCSV=arr=> (arr||[]).filter(Boolean).join(","); 
const genId=()=>`prd_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
const phoneCI = s => {
  const digits=(s||"").replace(/\D/g,"");
  if(digits.startsWith("225")) return "+225"+digits.slice(3);
  if(digits.length===10 && digits.startsWith("0")) return "+225"+digits.slice(1);
  if(digits.length===8) return "+225"+digits;
  if(digits.length===12 && digits.startsWith("225")) return "+225"+digits.slice(3);
  return "+225"+digits;
};
const showToast=(msg)=>{const t=$("#toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",2200);};
const isDemo=()=>!CONFIG.SCRIPT_URL||!CONFIG.API_TOKEN;

/* =========================
   API CLIENT (Apps Script)
========================= */
const api = {
  async list() {
    if (isDemo()) return demoData().filter(p => p.published);
    const url = new URL(CONFIG.SCRIPT_URL);
    url.searchParams.set("action", "list");
    const r = await fetch(url);            // GET simple (aucun header custom)
    const j = await r.json(); if (!j.ok) throw new Error(j.error || "Erreur API");
    return j.data;
  },

  async adminList() {
    if (isDemo()) return demoData();
    const url = new URL(CONFIG.SCRIPT_URL);
    url.searchParams.set("action","admin_list");
    url.searchParams.set("token", CONFIG.API_TOKEN);  // token dans l‚ÄôURL
    const r = await fetch(url);                       // GET simple
    const j = await r.json(); if (!j.ok) throw new Error(j.error || "Erreur API");
    return j.data;
  },

  async create(prod) {
    if (isDemo()) { showToast("D√©mo: cr√©ation locale"); return prod; }
    const body = { action:"create", token:CONFIG.API_TOKEN, produit: prod };
    const r = await fetch(CONFIG.SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // pas d‚Äôen-t√™te custom => pas de pr√©flight
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error || "Erreur API");
    return j.data;
  },

  async update(prod) {
    if (isDemo()) { showToast("D√©mo: mise √† jour locale"); return prod; }
    const body = { action:"update", token:CONFIG.API_TOKEN, produit: prod };
    const r = await fetch(CONFIG.SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error || "Erreur API");
    return j.data;
  },

  async del(id) {
    if (isDemo()) { showToast("D√©mo: suppression locale"); return true; }
    const body = { action:"delete", token:CONFIG.API_TOKEN, id };
    const r = await fetch(CONFIG.SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error || "Erreur API");
    return j.data;
  }
};

/* =========================
   CACHE PRODUITS
========================= */
const cache={
  get(){
    try{
      const raw=localStorage.getItem(LS_KEYS.CACHE); if(!raw) return null;
      const obj=JSON.parse(raw); if(Date.now()-obj.ts>CONFIG.CACHE_TTL_MS) return null;
      return obj.data;
    }catch{ return null; }
  },
  set(data){
    localStorage.setItem(LS_KEYS.CACHE, JSON.stringify({ts:Date.now(),data}));
  },
  clear(){ localStorage.removeItem(LS_KEYS.CACHE); }
};

/* =========================
   BOUTIQUE RENDERING
========================= */
let ALL_PRODUCTS=[];
function productImage(p){ return (parseCSV(p.images_csv)[0] || "https://images.unsplash.com/photo-1520975693416-35a7d069f78f?q=80&w=800&auto=format&fit=crop"); }

function renderProducts(list){
  const grid=$("#grid"); grid.innerHTML="";
  if(!list.length){ grid.innerHTML="<p class='muted'>Aucun produit.</p>"; return; }
  for(const p of list){
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`
      <img loading="lazy" alt="${escapeHtml(p.nom)}" src="${escapeAttr(productImage(p))}">
      <div class="body">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>${escapeHtml(p.nom)}</strong>
          ${Number(p.stock||0)<=0?'<span class="badge-sm">Rupture</span>':''}
        </div>
        <div class="price">${formatXOF(p.prix)}</div>
        <div class="muted">${escapeHtml(p.categorie||'‚Äî')}</div>
        <div class="actions"><button class="btn" data-id="${p.id}">Voir</button></div>
      </div>`;
    grid.appendChild(card);
  }
  grid.querySelectorAll("button[data-id]").forEach(b=>b.addEventListener("click",()=>openProduct(b.dataset.id)));
}

function categoriesFrom(list){
  return Array.from(new Set(list.map(x=>x.categorie).filter(Boolean))).sort();
}
function renderCategories(list){
  const wrap=$("#cats"); wrap.innerHTML="";
  const add=(name,val)=>{const a=document.createElement("a");a.href="#";a.className="chip";a.textContent=name;a.dataset.cat=val||"";a.addEventListener("click",(e)=>{e.preventDefault();filterBy(val)});wrap.appendChild(a);};
  add("Tout","");
  categoriesFrom(list).forEach(c=>add(c,c));
}
function filterBy(cat){
  const q=$("#q").value.toLowerCase().trim();
  let list=[...ALL_PRODUCTS].filter(p=>p.published);
  if(cat) list=list.filter(p=>(p.categorie||"").toLowerCase()===cat.toLowerCase());
  if(q) list=list.filter(p=>(p.nom+" "+(p.description||"")).toLowerCase().includes(q));
  const sort=$("#sort").value;
  if(sort==="price-asc") list.sort((a,b)=>a.prix-b.prix);
  if(sort==="price-desc") list.sort((a,b)=>b.prix-a.prix);
  if(sort==="new") list.sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
  renderProducts(list);
}

/* =========================
   MODALE PRODUIT
========================= */
let CURRENT=null;
function openProduct(id){
  const p=ALL_PRODUCTS.find(x=>x.id===id); if(!p) return;
  CURRENT=p;
  $("#mTitle").textContent=p.nom;
  $("#mPrice").textContent=formatXOF(p.prix);
  $("#mDesc").textContent=p.description||"";
  const imgs=parseCSV(p.images_csv);
  const thumbs=$("#mThumbs"); thumbs.innerHTML="";
  const main=$("#mMain"); main.innerHTML="";
  const show=(src,isVideo=false)=>{
    main.innerHTML=isVideo?`<video src="${escapeAttr(src)}" controls></video>`:`<img alt="${escapeHtml(p.nom)}" src="${escapeAttr(src)}">`;
  };
  imgs.forEach((src,i)=>{
    const im=document.createElement("img"); im.src=src; im.alt=""; if(i===0) im.classList.add("active");
    im.addEventListener("click",()=>{thumbs.querySelectorAll("img").forEach(t=>t.classList.remove("active"));im.classList.add("active");show(src,false);});
    thumbs.appendChild(im);
  });
  if(p.video_url){ const v=document.createElement("img"); v.src=imgs[0]||"https://via.placeholder.com/84x84?text=Vid"; v.alt=""; v.title="Vid√©o"; v.addEventListener("click",()=>show(p.video_url,true)); thumbs.appendChild(v); }
  show(imgs[0]||p.video_url||"");
  // tailles/couleurs
  const $size=$("#mSize"), $color=$("#mColor");
  $size.innerHTML=""; $color.innerHTML="";
  const sizes=parseCSV(p.tailles_csv); const colors=parseCSV(p.couleurs_csv);
  $size.appendChild(new Option(sizes[0]||"Taille unique",sizes[0]||"TU"));
  sizes.slice(1).forEach(s=>$size.appendChild(new Option(s,s)));
  $color.appendChild(new Option(colors[0]||"‚Äî",colors[0]||""));
  colors.slice(1).forEach(c=>$color.appendChild(new Option(c,c)));
  $("#mQty").value=1;
  const flags=$("#mFlags"); flags.innerHTML="";
  if(Number(p.stock||0)<=0) flags.innerHTML+='<span class="badge-sm">Rupture</span>';
  $("#productModal").classList.add("open");
}
$("#mClose").onclick=()=>$("#productModal").classList.remove("open");
$("#mMinus").onclick=()=>$("#mQty").value=Math.max(1, (+$("#mQty").value||1)-1);
$("#mPlus").onclick=()=>$("#mQty").value=(+$("#mQty").value||1)+1;
$("#mAdd").onclick=()=>{
  if(!CURRENT) return;
  addToCart({id:CURRENT.id,nom:CURRENT.nom,prix:+CURRENT.prix,qty:+$("#mQty").value||1, variante:{taille:$("#mSize").value||"",couleur:$("#mColor").value||""}, img:productImage(CURRENT)});
  $("#productModal").classList.remove("open");
  showToast("Ajout√© au panier");
};

/* =========================
   PANIER
========================= */
const cartStore={
  get(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.CART)||"[]"); }catch{return []}},
  set(items){ localStorage.setItem(LS_KEYS.CART, JSON.stringify(items)); },
  clear(){ localStorage.removeItem(LS_KEYS.CART); }
};
function addToCart(line){
  const items=cartStore.get();
  const key=(l)=>`${l.id}|${l.variante?.taille||""}|${l.variante?.couleur||""}`;
  const i=items.findIndex(x=>key(x)===key(line));
  if(i>=0) items[i].qty += line.qty; else items.push(line);
  cartStore.set(items); renderCart();
}
function removeFromCart(key){
  const items=cartStore.get().filter((_,i)=>i!==key); cartStore.set(items); renderCart();
}
function changeQty(key,delta){
  const items=cartStore.get(); items[key].qty=Math.max(1,(items[key].qty||1)+delta); cartStore.set(items); renderCart();
}
function cartTotal(){
  return cartStore.get().reduce((s,l)=>s+(+l.prix||0)*(+l.qty||1),0);
}
function renderCart(){
  const items=cartStore.get(); const box=$("#cartLines"); box.innerHTML="";
  items.forEach((l,i)=>{
    const div=document.createElement("div"); div.className="cart-line";
    div.innerHTML=`
      <img alt="" src="${escapeAttr(l.img||'')}">
      <div><strong>${escapeHtml(l.nom)}</strong><div class="muted">${escapeHtml(l.variante?.taille||'')} ${escapeHtml(l.variante?.couleur||'')}</div><div>${formatXOF(l.prix)}</div></div>
      <div>
        <div class="qty"><button onclick="changeQty(${i},-1)">‚àí</button><input value="${l.qty}" readonly><button onclick="changeQty(${i},1)">+</button></div>
        <div><a href="#" onclick="removeFromCart(${i});return false;">Supprimer</a></div>
      </div>`;
    box.appendChild(div);
  });
  $("#cartBadge").style.display=items.length?"inline-block":"none";
  $("#cartBadge").textContent=items.reduce((s,l)=>s+l.qty,0);
  $("#cartTotal").textContent=formatXOF(cartTotal());
}
$("#btnCart").onclick=()=>{$("#cart").classList.add("open");$("#cart").setAttribute("aria-hidden","false");};
$("#closeCart").onclick=()=>{$("#cart").classList.remove("open");$("#cart").setAttribute("aria-hidden","true");};
$("#emptyCart").onclick=()=>{cartStore.clear(); renderCart();};
$("#checkout").onclick=()=>{
  if($("#hp").value){showToast("Anti-spam activ√©");return;}
  const items=cartStore.get(); if(!items.length) return showToast("Panier vide");
  const name=$("#cName").value.trim(), phone=$("#cPhone").value.trim(), addr=$("#cAddr").value.trim();
  if(!name||!phone||!addr) return showToast("Veuillez remplir Nom, T√©l√©phone, Adresse");
  const phoneNorm=phoneCI(phone);
  const lines=items.map(l=>`‚Ä¢ ${l.nom} x${l.qty} (${l.variante?.taille||'-'}/${l.variante?.couleur||'-'}) ‚Äî ${l.prix} FCFA`).join("\n");
  const total=cartTotal();
  const msg=`Bonjour ${CONFIG.BUSINESS_NAME} üëó,
Nouvelle commande :
- Produits :
${lines}
Total : ${total} FCFA

Client :
‚Ä¢ Nom : ${name}
‚Ä¢ T√©l : ${phoneNorm}
‚Ä¢ Adresse : ${addr}
`;
  const url=`https://wa.me/${CONFIG.WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
};

/* =========================
   ADMIN AUTH & UI
========================= */
function isAuthed(){ try{ return JSON.parse(sessionStorage.getItem(LS_KEYS.SESSION)||"{}").ok; }catch{return false;}}
function requireAuth(){
  if(isAuthed()) return true;
  const u=prompt("Identifiant ADMIN ?","ADMIN"); if(u===null) return false;
  const p=prompt("Mot de passe ?",""); if(p===null) return false;
  if(u===CONFIG.ADMIN_USERNAME && p===CONFIG.ADMIN_PASSWORD){ sessionStorage.setItem(LS_KEYS.SESSION, JSON.stringify({ok:true,at:Date.now()})); showToast("Connect√©"); return true; }
  alert("Acc√®s refus√©"); return false;
}
function ensureAdmin(){
  if(location.hash==="#admin"){
    if(!requireAuth()){ location.hash="#"; return; }
    $("#admin").style.display="block"; loadAdmin();
  } else $("#admin").style.display="none";
}
window.addEventListener("hashchange", ensureAdmin);

/* Admin rendering */
let ADMIN_LIST=[];
async function loadAdmin(){
  $("#aStatus").textContent="Chargement‚Ä¶";
  try{
    ADMIN_LIST=isDemo()?demoData():await api.adminList();
    drawAdminTable(ADMIN_LIST);
    $("#aStatus").textContent=`${ADMIN_LIST.length} articles`;
  }catch(e){ $("#aStatus").textContent="Erreur : "+e.message; }
}
function drawAdminTable(rows){
  const q=$("#aSearch").value.toLowerCase().trim();
  const tb=$("#aTable tbody"); tb.innerHTML="";
  rows.filter(r=>!q || (r.nom+" "+(r.categorie||"")).toLowerCase().includes(q))
      .forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.nom)}</td>
          <td>${formatXOF(r.prix)}</td>
          <td>${escapeHtml(r.categorie||'')}</td>
          <td><input type="checkbox" ${r.published?'checked':''} data-id="${r.id}" class="switch"></td>
          <td>${Number(r.stock||0)}</td>
          <td><a href="#" data-edit="${r.id}">√âditer</a></td>`;
        tb.appendChild(tr);
      });
  tb.querySelectorAll('input.switch').forEach(sw=>{
    sw.addEventListener("change", async ()=>{
      const row=ADMIN_LIST.find(x=>x.id===sw.dataset.id); if(!row) return;
      row.published=sw.checked; row.updated_at=nowISO();
      try{ await api.update(row); cache.clear(); showToast("Publi√© modifi√©"); }catch(e){ alert(e.message); sw.checked=!sw.checked; }
    });
  });
  tb.querySelectorAll('a[data-edit]').forEach(a=>{
    a.addEventListener("click",(e)=>{
      e.preventDefault();
      const row=ADMIN_LIST.find(x=>x.id===a.dataset.edit); if(!row) return;
      fillForm(row);
    });
  });
}
function formData(){
  return {
    id: $("#f_id").value.trim()||genId(),
    nom: $("#f_nom").value.trim(),
    prix: Number($("#f_prix").value||0),
    description: $("#f_desc").value.trim(),
    categorie: $("#f_cat").value.trim(),
    images_csv: $("#f_imgs").value.trim(),
    video_url: $("#f_vid").value.trim(),
    tailles_csv: $("#f_sizes").value.trim(),
    couleurs_csv: $("#f_colors").value.trim(),
    stock: Number($("#f_stock").value||0),
    published: $("#f_pub").checked,
    created_at: $("#f_id").value? undefined : nowISO(),
    updated_at: nowISO()
  };
}
function fillForm(p){
  $("#f_id").value=p.id||"";
  $("#f_nom").value=p.nom||"";
  $("#f_prix").value=p.prix||"";
  $("#f_desc").value=p.description||"";
  $("#f_cat").value=p.categorie||"";
  $("#f_imgs").value=p.images_csv||"";
  $("#f_vid").value=p.video_url||"";
  $("#f_stock").value=p.stock||0;
  $("#f_sizes").value=p.tailles_csv||"";
  $("#f_colors").value=p.couleurs_csv||"";
  $("#f_pub").checked=!!p.published;
}
function validForm(p){
  if(!p.nom||!p.prix||!p.categorie||!p.images_csv){ alert("Champs requis manquants"); return false; }
  if(p.prix<0){ alert("Prix invalide"); return false; }
  return true;
}
$("#aCreate").onclick=async()=>{
  const p=formData(); if(!validForm(p)) return;
  try{ await api.create(p); showToast("Cr√©√©"); cache.clear(); await loadAdmin(); }catch(e){ alert(e.message); }
};
$("#aUpdate").onclick=async()=>{
  const p=formData(); if(!p.id){ alert("ID requis"); return; }
  try{ await api.update(p); showToast("Mis √† jour"); cache.clear(); await loadAdmin(); }catch(e){ alert(e.message); }
};
$("#aDelete").onclick=async()=>{
  const id=$("#f_id").value.trim(); if(!id) return alert("ID requis");
  if(!confirm("Supprimer cet article ?")) return;
  try{ await api.del(id); showToast("Supprim√©"); cache.clear(); await loadAdmin(); }catch(e){ alert(e.message); }
};
$("#aRefresh").onclick=()=>{ cache.clear(); loadAll(); if(isAuthed()) loadAdmin(); };
$("#aExport").onclick=()=>{
  const data=JSON.stringify(ADMIN_LIST,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="redgreen_products.json"; a.click();
};
$("#aLogout").onclick=()=>{ sessionStorage.removeItem(LS_KEYS.SESSION); location.hash="#"; ensureAdmin(); };
$("#aSearch").addEventListener("input",()=>drawAdminTable(ADMIN_LIST));

/* =========================
   LOADING DATA FLOW
========================= */
async function loadAll(){
  $("#year").textContent=new Date().getFullYear();
  $("#btnWhats").href=`https://wa.me/${CONFIG.WHATSAPP_PHONE}`;
  $("#btnWhats2").href=`https://wa.me/${CONFIG.WHATSAPP_PHONE}`;

  $("#demoBanner").style.display=isDemo()?"block":"none";

  let data = cache.get();
  if(!data){
    try{ data = await api.list(); cache.set(data); }
    catch(e){ console.warn(e); data = demoData().filter(p=>p.published); showToast("Hors-ligne: d√©mo"); }
  }
  ALL_PRODUCTS=data;
  renderCategories(ALL_PRODUCTS);
  filterBy("");
}
$("#q").addEventListener("input",()=>filterBy(""));
$("#sort").addEventListener("change",()=>filterBy(""));

/* =========================
   DEMO DATA (fallback)
========================= */
function demoData(){
  return [
    {id:"prd_demo_1",nom:"Robe midi satin",prix:25000,description:"Coupe √©l√©gante, id√©ale soir√©e.",categorie:"Robes",images_csv:"https://images.unsplash.com/photo-1542060748-10c28b62716f?q=80&w=800&auto=format&fit=crop,https://images.unsplash.com/photo-1520975693416-35a7d069f78f?q=80&w=800&auto=format&fit=crop",video_url:"",tailles_csv:"S,M,L",couleurs_csv:"Rouge,Noir",stock:6,published:true,created_at:nowISO(),updated_at:nowISO()},
    {id:"prd_demo_2",nom:"Ensemble casual vert",prix:35000,description:"Confort & style quotidien.",categorie:"Ensembles",images_csv:"https://images.unsplash.com/photo-1475180098004-ca77a66827be?q=80&w=800&auto=format&fit=crop",video_url:"",tailles_csv:"M,L,XL",couleurs_csv:"Vert",stock:0,published:true,created_at:nowISO(),updated_at:nowISO()},
    {id:"prd_demo_3",nom:"Sac bandouli√®re",prix:18000,description:"Accessoire chic.",categorie:"Accessoires",images_csv:"https://images.unsplash.com/photo-1511561415786-cc44c56d96a6?q=80&w=800&auto=format&fit=crop",video_url:"",tailles_csv:"TU",couleurs_csv:"Noir,Beige",stock:12,published:true,created_at:nowISO(),updated_at:nowISO()},
    {id:"prd_demo_4",nom:"Robe soir√©e sequins",prix:42000,description:"Brillez en soir√©e.",categorie:"Promotions",images_csv:"https://images.unsplash.com/photo-1517677208171-0bc6725a3e60?q=80&w=800&auto=format&fit=crop",video_url:"",tailles_csv:"S,M",couleurs_csv:"Dor√©",stock:3,published:false,created_at:nowISO(),updated_at:nowISO()},
  ];
}

/* =========================
   HELPERS
========================= */
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}
function escapeAttr(s){return escapeHtml(s)}

/* =========================
   BOOT
========================= */
document.addEventListener("keydown",e=>{ if(e.key==="/"){ e.preventDefault(); $("#q").focus(); }});
$("#adminLink").addEventListener("click",(e)=>{ if(!requireAuth()){ e.preventDefault(); return; } });
$("#btnAdmin").addEventListener("click",(e)=>{ if(!requireAuth()){ e.preventDefault(); location.hash="#"; return; } });

renderCart(); loadAll(); ensureAdmin();
</script>

<!--
=========================
 APPS SCRIPT (Code.gs)
=========================
Collez ce script dans Google Sheets (Extensions ‚Üí Apps Script), remplacez API_TOKEN_SHEET,
puis D√©ployer ‚Üí Nouvelle application web ‚Üí Acc√®s : Tout le monde. Copiez l‚ÄôURL dans CONFIG.SCRIPT_URL.

function doGet(e){
  const token = (e && (e.parameter['X-API-KEY'] || e.parameter['token'])) || "";
  const action = e && e.parameter && e.parameter.action;
  return withCors(() => {
    if(!checkToken(token) && action!=="list"){ return json({ok:false,error:"Unauthorized"},403); }
    const sh = getSheet();
    ensureHeader(sh);
    if(action==="list"){
      const rows = readRows(sh).filter(r=>String(r.published).toLowerCase()==="true");
      return json({ok:true,data:rows});
    }
    if(action==="admin_list"){
      const rows = readRows(sh);
      return json({ok:true,data:rows});
    }
    return json({ok:false,error:"Unknown action"},400);
  });
}

function doPost(e){
  return withCors(() => {
    const token = e && e.postData && (JSON.parse(e.postData.contents).token || (e.parameter && e.parameter['X-API-KEY']));
    const body = e && e.postData && JSON.parse(e.postData.contents);
    if(!checkToken((e && e.parameter && e.parameter['X-API-KEY']) || (body && body.token) || (e && e.parameter && e.parameter.token) || "")){
      // Also allow header X-API-KEY
      const hdr = e && e.parameter && e.parameter['X-API-KEY'];
      if(!checkToken(hdr)) return json({ok:false,error:"Unauthorized"},403);
    }
    const sh = getSheet(); ensureHeader(sh);
    const action = body && body.action;
    if(action==="create"){
      const p = sanitizeProduct(body.produit); if(!p.id) p.id = "prd_"+Date.now()+"_"+rand4();
      p.created_at = p.created_at || nowISO(); p.updated_at = nowISO();
      sh.appendRow(productToRow(p));
      return json({ok:true,data:p});
    }
    if(action==="update"){
      const p = sanitizeProduct(body.produit); if(!p.id) return json({ok:false,error:"Missing id"},400);
      const row = findRowById(sh,p.id); if(row<2) return json({ok:false,error:"Not found"},404);
      p.updated_at = nowISO();
      sh.getRange(row,1,1,HEADERS.length).setValues([productToRow(p)]);
      return json({ok:true,data:p});
    }
    if(action==="delete"){
      const id = body && body.id; if(!id) return json({ok:false,error:"Missing id"},400);
      const row = findRowById(sh,id); if(row<2) return json({ok:false,error:"Not found"},404);
      sh.deleteRow(row);
      return json({ok:true,data:true});
    }
    return json({ok:false,error:"Unknown action"},400);
  });
}

/*** Helpers ***/
const SHEET_NAME="Produits";
const API_TOKEN_SHEET="change-me-long-secret";
const HEADERS=["id","nom","prix","description","categorie","images_csv","video_url","tailles_csv","couleurs_csv","stock","published","created_at","updated_at"];

function withCors(fn){
  try{
    const res=fn();
    return addCors(res);
  }catch(err){
    return addCors(json({ok:false,error:String(err)} ,500));
  }
}
function addCors(res){
  return ContentService
    .createTextOutput(res.getContent())
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin","*")
    .setHeader("Access-Control-Allow-Headers","Content-Type,X-API-KEY")
    .setHeader("Access-Control-Allow-Methods","GET,POST,OPTIONS");
}
function json(obj,code){
  const out=ContentService.createTextOutput(JSON.stringify(obj));
  if(code){ out.setMimeType(ContentService.MimeType.JSON); }
  return out;
}
function checkToken(t){ return String(t||"")===API_TOKEN_SHEET; }
function getSheet(){
  const ss=SpreadsheetApp.getActiveSpreadsheet();
  let sh=ss.getSheetByName(SHEET_NAME); if(!sh) sh=ss.insertSheet(SHEET_NAME);
  return sh;
}
function ensureHeader(sh){
  const h=sh.getRange(1,1,1,HEADERS.length).getValues()[0];
  if(h[0]!==HEADERS[0]) sh.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
}
function readRows(sh){
  const rng=sh.getDataRange().getValues(); const rows=[];
  for(let i=1;i<rng.length;i++){
    const r=rng[i]; if(!r[0]) continue;
    rows.push(rowToProduct(r));
  }
  return rows;
}
function productToRow(p){
  return [
    p.id||"", p.nom||"", num(p.prix), p.description||"", p.categorie||"",
    p.images_csv||"", p.video_url||"", p.tailles_csv||"", p.couleurs_csv||"",
    num(p.stock), bool(p.published), p.created_at||"", p.updated_at||""
  ];
}
function rowToProduct(r){
  return {
    id:r[0], nom:r[1], prix:num(r[2]), description:r[3], categorie:r[4],
    images_csv:r[5], video_url:r[6], tailles_csv:r[7], couleurs_csv:r[8],
    stock:num(r[9]), published:bool(r[10]), created_at:r[11], updated_at:r[12]
  };
}
function findRowById(sh,id){
  const col=sh.getRange(2,1,sh.getLastRow()-1,1).getValues().map(x=>x[0]);
  const idx=col.indexOf(id);
  return idx<0? -1 : (idx+2);
}
function sanitizeProduct(p){
  if(!p) return {};
  p.nom=String(p.nom||"").trim();
  p.description=String(p.description||"").trim();
  p.categorie=String(p.categorie||"").trim();
  p.images_csv=String(p.images_csv||"").trim();
  p.video_url=String(p.video_url||"").trim();
  p.tailles_csv=String(p.tailles_csv||"").trim();
  p.couleurs_csv=String(p.couleurs_csv||"").trim();
  p.stock=num(p.stock); p.prix=num(p.prix);
  p.published=bool(p.published);
  return p;
}
function num(v){ v=Number(v||0); return isNaN(v)?0:v; }
function bool(v){ return String(v).toLowerCase()==="true" || v===true || v===1; }
function nowISO(){ return new Date().toISOString(); }
function rand4(){ return Math.random().toString(36).slice(2,6); }

NOTE: si vous recevez une erreur 403, v√©rifiez API_TOKEN c√¥t√© site (CONFIG.API_TOKEN) et c√¥t√© Apps Script (API_TOKEN_SHEET).
-->

</body>
</html>
